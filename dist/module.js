define(["lodash","app/plugins/sdk"],(function(__WEBPACK_EXTERNAL_MODULE__0__,__WEBPACK_EXTERNAL_MODULE__2__){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=7)}([function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE__0__},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return PNPDatasource}));var lodash__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),lodash__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(lodash__WEBPACK_IMPORTED_MODULE_0__);function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var PNPDatasource=function(){function PNPDatasource(e,t,r,a){_classCallCheck(this,PNPDatasource),this.type=e.type,this.url=e.url,this.name=e.name,this.q=t,this.backendSrv=r,this.templateSrv=a,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,this.DEFAULT_HOST="select host",this.DEFAULT_SERVICE="select service",this.DEFAULT_PERFLABEL="select performance label",this.name=e.name,this.id=e.id}return _createClass(PNPDatasource,[{key:"query",value:function(e){var t=this.buildQueryParameters(e);if(t.targets=t.targets.filter((function(e){return!e.hide})),t.targets=t.targets.filter((function(e){return e.host})),t.targets=t.targets.filter((function(e){return e.service})),t.targets=t.targets.filter((function(e){return e.perflabel})),t.targets.length<=0)return this.q.when({data:[]});t.start=Number(e.range.from.toDate().getTime()/1e3).toFixed(),t.end=Number(e.range.to.toDate().getTime()/1e3).toFixed();for(var r=0;r<t.targets.length;r++){var a=t.targets[r];a.host==this.DEFAULT_HOST&&(a.host=""),a.service==this.DEFAULT_SERVICE&&(a.service=""),a.perflabel==this.DEFAULT_PERFLABEL&&(a.perflabel=""),a.host=this._fixup_regex(a.host),a.service=this._fixup_regex(a.service),a.perflabel=this._fixup_regex(a.perflabel)}var n=this,o=this._requestOptions({url:this.url+"/index.php/api/metrics",data:t,method:"POST",headers:{"Content-Type":"application/json"}});return this.backendSrv.datasourceRequest(o).then((function(t){return n.dataQueryMapper(t,e)}))}},{key:"dataQueryMapper",value:function dataQueryMapper(result,options){var data={data:[]};if(!result||!result.data||!result.data.targets)return data;for(var x=0;x<result.data.targets.length;x++)for(var k=0;k<result.data.targets[x].length;k++){var target=options.targets[x],res=result.data.targets[x][k],alias=target.perflabel;if(target.alias){alias=target.alias;var scopedVars={tag_host:{value:res.host},tag_service:{value:res.service},tag_perflabel:{value:res.perflabel},tag_label:{value:res.perflabel}};alias=this.templateSrv.replace(alias,scopedVars)}for(var datapoints=res.datapoints,length=datapoints.length,y=1;y<5&&(length>y&&null===datapoints[length-y][0]);y++)datapoints.pop();var length=datapoints.length,fill=options.targets[x].fill;if("fill"!=fill){"zero"==fill&&(fill=0),"gap"==fill&&(fill=void 0);for(var y=0;y<length;y++)null===datapoints[y][0]&&(datapoints[y][0]=fill)}if(options.targets[x].factor&&""!=options.targets[x].factor){var factor=eval(options.targets[x].factor);if(NaN!=factor&&1!=factor)for(var y=0;y<length;y++)null!==datapoints[y][0]&&(datapoints[y][0]*=factor)}data.data.push({target:alias,datapoints:datapoints})}return data}},{key:"_fixup_regex",value:function(e){if(null==e||null==e)return e;var t=e.match(/^\/?\^?\{(.*)\}\$?\/?$/);if(!t)return e;for(var r=t[1].split(/,/),a=0;a<r.length;a++)r[a]=r[a].replace(/\//,"\\/");return"/^("+r.join("|")+")$/"}},{key:"testDatasource",value:function(){var e=this._requestOptions({url:this.url+"/index.php/api",method:"GET"});return this.backendSrv.datasourceRequest(e).then((function(e){if(200===e.status)return{status:"success",message:"Data source is working",title:"Success"}})).catch((function(e){return e.status&&e.status>=400?{status:"error",message:"Data source not connected: "+e.status+" "+e.statusText}:{status:"error",message:e.message}}))}},{key:"metricFindQuery",value:function(e){var t,r={},a=e.split(/\s+/);if(a[0]&&(t=a.shift().replace(/s$/,"")),null!=a[0]){if("where"!=a[0].toLowerCase())throw new Error("query syntax error, expecting WHERE");for(a.shift();a.length>=3;){var n=a.shift().toLowerCase(),o=a.shift().toLowerCase(),i=a.shift();if("="!=o)throw new Error("query syntax error, operator must be '='");if(r[n]=i,null!=a[0]){if("and"!=a[0].toLowerCase())throw new Error("query syntax error, expecting AND");a.shift()}}if(a.length>0)throw new Error("query syntax error")}return this.metricFindData(t,r,!1)}},{key:"metricFindData",value:function(e,t,r){var a,n,o=this,i={};if("host"==e?(n=o.url+"/index.php/api/hosts",a=o.mapToTextValueHost):"service"==e?(n=o.url+"/index.php/api/services/",i.host=o._fixup_regex(o.templateSrv.replace(t.host)),a=o.mapToTextValueService,i.host||(i.host="/.*/")):"perflabel"!=e&&"label"!=e||(n=o.url+"/index.php/api/labels/",i.host=o._fixup_regex(o.templateSrv.replace(t.host)),i.service=o._fixup_regex(o.templateSrv.replace(t.service)),a=o.mapToTextValuePerflabel,i.host||(i.host="/.*/"),i.service||(i.service="/.*/")),null==n)throw new Error("query syntax error, got no url, unknown type: "+e);var s=o._requestOptions({url:n,data:i,method:"POST",headers:{"Content-Type":"application/json"}});return o.backendSrv.datasourceRequest(s).then(a).then((function(e){if(r)for(var t=0;t<o.templateSrv.variables.length;t++)e.unshift({text:"/^$"+o.templateSrv.variables[t].name+"$/",value:"/^$"+o.templateSrv.variables[t].name+"$/"});return e}))}},{key:"mapToTextValueHost",value:function(e){return lodash__WEBPACK_IMPORTED_MODULE_0___default.a.map(e.data.hosts,(function(e,t){return{text:e.name,value:e.name}}))}},{key:"mapToTextValueService",value:function(e){return lodash__WEBPACK_IMPORTED_MODULE_0___default.a.map(e.data.services,(function(e,t){return{text:e.servicedesc||e.name,value:e.name}}))}},{key:"mapToTextValuePerflabel",value:function(e){return lodash__WEBPACK_IMPORTED_MODULE_0___default.a.map(e.data.labels,(function(e,t){return{text:e.label||e.name,value:e.label||e.name}}))}},{key:"buildQueryParameters",value:function(e){var t=this;e.targets=lodash__WEBPACK_IMPORTED_MODULE_0___default.a.filter(e.targets,(function(e){return e.host!==t.DEFAULT_HOST})),e.targets=lodash__WEBPACK_IMPORTED_MODULE_0___default.a.filter(e.targets,(function(e){return e.service!==t.DEFAULT_SERVICE})),e.targets=lodash__WEBPACK_IMPORTED_MODULE_0___default.a.filter(e.targets,(function(e){return e.perflabel!==t.DEFAULT_PERFLABEL}));var r=lodash__WEBPACK_IMPORTED_MODULE_0___default.a.map(e.targets,(function(r){return{host:t.templateSrv.replace(t.templateSrv.replace(r.host,e.scopedVars)),service:t.templateSrv.replace(t.templateSrv.replace(r.service,e.scopedVars)),perflabel:t.templateSrv.replace(t.templateSrv.replace(r.perflabel,e.scopedVars)),alias:t.templateSrv.replace(t.templateSrv.replace(r.alias,e.scopedVars)),type:t.templateSrv.replace(t.templateSrv.replace(r.type,e.scopedVars)),fill:t.templateSrv.replace(t.templateSrv.replace(r.fill,e.scopedVars)),factor:t.templateSrv.replace(t.templateSrv.replace(r.factor,e.scopedVars)),refId:r.refId,hide:r.hide}}));return e.targets=r,e}},{key:"_requestOptions",value:function(e){return(e=e||{}).headers=e.headers||{},(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers.Authorization=this.basicAuth),e}}]),PNPDatasource}()},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE__2__},function(e,t,r){var a=r(4),n=r(5);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[e.i,n,""]]);var o={insert:"head",singleton:!1},i=(a(n,o),n.locals?n.locals:{});e.exports=i},function(e,t,r){"use strict";var a,n=function(){return void 0===a&&(a=Boolean(window&&document&&document.all&&!window.atob)),a},o=function(){var e={};return function(t){if(void 0===e[t]){var r=document.querySelector(t);if(window.HTMLIFrameElement&&r instanceof window.HTMLIFrameElement)try{r=r.contentDocument.head}catch(e){r=null}e[t]=r}return e[t]}}(),i=[];function s(e){for(var t=-1,r=0;r<i.length;r++)if(i[r].identifier===e){t=r;break}return t}function u(e,t){for(var r={},a=[],n=0;n<e.length;n++){var o=e[n],u=t.base?o[0]+t.base:o[0],l=r[u]||0,c="".concat(u," ").concat(l);r[u]=l+1;var f=s(c),p={css:o[1],media:o[2],sourceMap:o[3]};-1!==f?(i[f].references++,i[f].updater(p)):i.push({identifier:c,updater:v(p,t),references:1}),a.push(c)}return a}function l(e){var t=document.createElement("style"),a=e.attributes||{};if(void 0===a.nonce){var n=r.nc;n&&(a.nonce=n)}if(Object.keys(a).forEach((function(e){t.setAttribute(e,a[e])})),"function"==typeof e.insert)e.insert(t);else{var i=o(e.insert||"head");if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(t)}return t}var c,f=(c=[],function(e,t){return c[e]=t,c.filter(Boolean).join("\n")});function p(e,t,r,a){var n=r?"":a.media?"@media ".concat(a.media," {").concat(a.css,"}"):a.css;if(e.styleSheet)e.styleSheet.cssText=f(t,n);else{var o=document.createTextNode(n),i=e.childNodes;i[t]&&e.removeChild(i[t]),i.length?e.insertBefore(o,i[t]):e.appendChild(o)}}function h(e,t,r){var a=r.css,n=r.media,o=r.sourceMap;if(n?e.setAttribute("media",n):e.removeAttribute("media"),o&&btoa&&(a+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}var d=null,_=0;function v(e,t){var r,a,n;if(t.singleton){var o=_++;r=d||(d=l(t)),a=p.bind(null,r,o,!1),n=p.bind(null,r,o,!0)}else r=l(t),a=h.bind(null,r,t),n=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(r)};return a(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;a(e=t)}else n()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=n());var r=u(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var a=0;a<r.length;a++){var n=s(r[a]);i[n].references--}for(var o=u(e,t),l=0;l<r.length;l++){var c=s(r[l]);0===i[c].references&&(i[c].updater(),i.splice(c,1))}r=o}}}},function(e,t,r){(t=r(6)(!0)).push([e.i,".generic-datasource-query-row .query-keyword{width:75px}\n","",{version:3,sources:["query-editor.css"],names:[],mappings:"AAAA,6CAA6C,UAAU",file:"query-editor.css",sourcesContent:[".generic-datasource-query-row .query-keyword{width:75px}\n"]}]),e.exports=t},function(e,t,r){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var r=function(e,t){var r=e[1]||"",a=e[3];if(!a)return r;if(t&&"function"==typeof btoa){var n=(i=a,s=btoa(unescape(encodeURIComponent(JSON.stringify(i)))),u="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),"/*# ".concat(u," */")),o=a.sources.map((function(e){return"/*# sourceURL=".concat(a.sourceRoot||"").concat(e," */")}));return[r].concat(o).concat([n]).join("\n")}var i,s,u;return[r].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(r,"}"):r})).join("")},t.i=function(e,r,a){"string"==typeof e&&(e=[[null,e,""]]);var n={};if(a)for(var o=0;o<this.length;o++){var i=this[o][0];null!=i&&(n[i]=!0)}for(var s=0;s<e.length;s++){var u=[].concat(e[s]);a&&n[u[0]]||(r&&(u[2]?u[2]="".concat(r," and ").concat(u[2]):u[2]=r),t.push(u))}},t}},function(e,t,r){"use strict";r.r(t);var a=r(1),n=r(2);r(3);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,a=c(e);if(t){var n=c(this).constructor;r=Reflect.construct(a,arguments,n)}else r=a.apply(this,arguments);return l(this,r)}}function l(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var f=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(o,e);var t,r,a,n=u(o);function o(e,t,r){var a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(a=n.call(this,e,t)).scope=e,a.uiSegmentSrv=r,a.target.host=a.target.host||a.datasource.DEFAULT_HOST,a.target.service=a.target.service||a.datasource.DEFAULT_SERVICE,a.target.perflabel=a.target.perflabel||a.datasource.DEFAULT_PERFLABEL,a.target.type=a.target.type||"AVERAGE",a.target.fill=a.target.fill||"fill",a.target.factor=a.target.factor||"",a}return t=o,(r=[{key:"getHost",value:function(){return this.datasource.metricFindData("host",this.target,!0).then(this.uiSegmentSrv.transformToSegments(!1))}},{key:"getService",value:function(){return this.datasource.metricFindData("service",this.target,!0).then(this.uiSegmentSrv.transformToSegments(!1))}},{key:"getPerflabel",value:function(){return this.datasource.metricFindData("perflabel",this.target,!0).then(this.uiSegmentSrv.transformToSegments(!1))}},{key:"onChangeInternal",value:function(){this.panelCtrl.refresh()}},{key:"getCollapsedText",value:function(){return this.target.perflabel==this.datasource.DEFAULT_PERFLABEL&&this.target.host==this.datasource.DEFAULT_HOST&&this.target.service==this.datasource.DEFAULT_SERVICE?"click to edit query":this.target.perflabel+": "+this.target.host+" - "+this.target.service}}])&&i(t.prototype,r),a&&i(t,a),o}(n.QueryCtrl);function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}f.templateUrl="partials/query.editor.html",r.d(t,"ConfigCtrl",(function(){return h})),r.d(t,"QueryOptionsCtrl",(function(){return d})),r.d(t,"AnnotationsQueryCtrl",(function(){return _})),r.d(t,"Datasource",(function(){return a.a})),r.d(t,"QueryCtrl",(function(){return f}));var h=function e(){p(this,e)};h.templateUrl="partials/config.html";var d=function e(){p(this,e)};d.templateUrl="partials/query.options.html";var _=function e(){p(this,e)};_.templateUrl="partials/annotations.editor.html"}])}));
//# sourceMappingURL=module.js.map